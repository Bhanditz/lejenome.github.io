<!DOCTYPE html> <html lang="en" itemscope itemType="http://schema.org/TechArticle"> <head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# website: http://ogp.me/ns/website# type: http://ogp.me/ns/profile#"> <meta charset="utf-8"> <title itemprop="name">Boot physical Windows inside Qemu guest machine | Moez Bouhlel</title> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <meta name="description" content="Moez Bouhlel (lejenome) website for latest updates. Hire me for a part-time job or for an internship at https://lejenome.github.io/resume"> <meta name="keywords" content="linux,qemu,kvm,windows,moez,bouhlel,lejenome,bmoez,bmoezj,bmoez.j" itemprop="keywords"> <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no,width=device-width,minimum-scale=1"> <meta name="author" content="Moez Bouhlel" itemprop="creator"> <meta name="copyright" content="Moez Bouhlel 2016, All Rights Reserved."> <link rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"> <base href="/"> <link rel="alternate" type="application/rss+xml" href="rss.xml"> <meta name="google-site-verification" content="S6sLGAfoubJHu5uLGJMU9sOD82LL7APn_EYSZQPOXsE"> <meta name="flattr:id" content="wlwnr0"> <link rel="openid.server" href="https://login.launchpad.net/+openid"> <link rel="openid.delegate" href="https://login.launchpad.net/+id/mBmWsYt"> <link rel="openid2.provider" href="https://login.launchpad.net/+openid"> <link rel="openid2.local_id" href="https://login.launchpad.net/+id/mBmWsYt"> <meta http-equiv="X-XRDS-Location" content="https://login.launchpad.net/+id/mBmWsYt/+xrds"> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@lejenome"> <meta name="twitter:creator" content="@lejenome"> <meta name="twitter:domain" content="lejenome.github.io"> <meta property="og:site_name" content="Moez Bouhlel"> <meta property="og:type" content="article"> <meta itemprop="inLanguage" content="en"> <meta property="og:url" itemprop="url" content="https://lejenome.github.io/post/boot-physical-windows-inside-qemu-guest-machine"> <meta name="twitter:description" property="og:description" itemprop="description" content="Moez Bouhlel (lejenome) Website for latest updates."> <meta name="twitter:title" property="og:title" content="Boot physical Windows inside Qemu guest machine | Moez Bouhlel"> <meta name="twitter:image" property="og:image" itemprop="image" content="https://lejenome.github.io/logo.png"> <link rel="apple-touch-icon-precomposed" sizes="57x57" href="imgs/favicon/apple-touch-icon-57x57.png"> <link rel="apple-touch-icon-precomposed" sizes="114x114" href="imgs/favicon/apple-touch-icon-114x114.png"> <link rel="apple-touch-icon-precomposed" sizes="72x72" href="imgs/favicon/apple-touch-icon-72x72.png"> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="imgs/favicon/apple-touch-icon-144x144.png"> <link rel="apple-touch-icon-precomposed" sizes="60x60" href="imgs/favicon/apple-touch-icon-60x60.png"> <link rel="apple-touch-icon-precomposed" sizes="120x120" href="imgs/favicon/apple-touch-icon-120x120.png"> <link rel="apple-touch-icon-precomposed" sizes="76x76" href="imgs/favicon/apple-touch-icon-76x76.png"> <link rel="apple-touch-icon-precomposed" sizes="152x152" href="imgs/favicon/apple-touch-icon-152x152.png"> <link rel="icon" type="image/png" href="imgs/favicon/favicon-196x196.png" sizes="196x196"> <link rel="icon" type="image/png" href="imgs/favicon/favicon-96x96.png" sizes="96x96"> <link rel="icon" type="image/png" href="imgs/favicon/favicon-32x32.png" sizes="32x32"> <link rel="icon" type="image/png" href="imgs/favicon/favicon-16x16.png" sizes="16x16"> <link rel="icon" type="image/png" href="imgs/favicon/favicon-128.png" sizes="128x128"> <meta name="msapplication-TileImage" content="imgs/favicon/mstile-144x144.png"> <meta name="msapplication-square70x70logo" content="imgs/favicon/mstile-70x70.png"> <meta name="msapplication-square150x150logo" content="imgs/favicon/mstile-150x150.png"> <meta name="msapplication-wide310x150logo" content="imgs/favicon/mstile-310x150.png"> <meta name="msapplication-square310x310logo" content="imgs/favicon/mstile-310x310.png"> <link href="css/style.css" type="text/css" rel="stylesheet"> <script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src="https://www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-28759938-2","auto"),ga("_trackPageLoadTime"),ga("send","pageview")</script> </head> <body class="container"> <header> <h1><a href="">Moez Bouhlel <small>@lejenome</small></a></h1> <nav> <ul class="menu"> <li><a href="">Home</a></li> <li><a href="https://twitter.com/lejenome">Twitter</a></li> <li><a href="https://github.com/lejenome">GitHub</a></li> <li><a href="https://www.linkedin.com/in/lejenome">LinkedIn</a></li> <li><a href="resume" rel="author">Resume</a></li> <li><a href="contact">Contact</a></li> </ul> <ul class="icons"> <li><a rel="archives" title="Archive" href="archive"><i class="fa fa-folder-open"></i></a></li> <li><a title="RSS" rel="alternate" type="application/rss+xml" href="rss.xml"><i class="fa fa-rss"></i></a></li> </ul> </nav> </header> <div> <section id="articales" class="type-post"> <article class="post" id="boot-physical-windows-inside-qemu-guest-machine"> <meta itemprop="proficiencyLevel" content="Beginner"> <link itemprop="publisher" href="https://lejenome.github.io/resume" rel="author"> <hgroup> <h2 class="post-title" itemprop="name" itemprop="headline"><a href="post/boot-physical-windows-inside-qemu-guest-machine" class="post-link" itemprop="url" rel="bookmark">Boot physical Windows inside Qemu guest machine</a></h2> <h3 class="post-date"> <time datetime="2017/02/14" itemprop="datePublished">Tue Feb 14 2017</time> - <a href="https://github.com/lejenome/lejenome.github.io/blob/master/posts/boot-physical-windows-inside-qemu.rst" rel="edit"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> edit</a> </h3> </hgroup> <div class="post-body" itemprop="articleBody"> <p>Recently, I needed to setup a new Windows system for use in an Internship project. Like the old setup which was described on an <a class="reference external" href="/post/dualboolt-guest-window-machine">older post</a>, I needed to have access to the same Windows from inside Qemu and from dual-boot for performance reseasons. But instead of requiring to install Windows two times (once directly on PC as host and the other inside Qemu) which caused some issues including slow filesystem operations when booting as host system, I did an update to setup instructions this time.</p> <p>For the virtual machine, we will use <em>Qemu/KVM</em> with <em>Ovmf</em> EFI bios.</p> <p>First, Install Windows directly on your PC then reboot back to Linux. Check that <tt class="docutils literal">loop</tt> and <tt class="docutils literal">linear</tt> modules are loaded:</p> <pre class="code shell literal-block">
sudo modprobe loop
sudo modprobe linear
</pre> <p>New, we need to create a virtual RAID disk for Qemu that will hold our physical Windows partition. As we will use GPT partitions table schema, we will allocate few megabytes <tt class="docutils literal">efi1</tt> for GPT metadata (34 Sectors) and for EFI partition before Windows partition and one megabyte <tt class="docutils literal">efi2</tt> after Windows partition for GPT secondary metadata (even we need just 34 Sectors, we will use one megabyte for best RAID performance)</p> <pre class="code shell literal-block">
dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>efi1 <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">count</span><span class="o">=</span><span class="m">100</span>
dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>efi2 <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">count</span><span class="o">=</span><span class="m">1</span>
</pre> <p>Now that we have <tt class="docutils literal">efi1</tt> file of 100 MB (100 * 1M) and <tt class="docutils literal">efi2</tt> of 1 MB. Next, we create a loopback devices from both files:</p> <pre class="code shell literal-block">
sudo losetup -f efi1
sudo losetup -f efi2
</pre> <p>We will assume that the assigned devices are <tt class="docutils literal">/dev/loop0</tt> and <tt class="docutils literal">/dev/loop1</tt> for <tt class="docutils literal">efi1</tt> and <tt class="docutils literal">efi2</tt> respectively. To check the assigned devices, type:</p> <pre class="code shell literal-block">
losetup -a
</pre> <p>Next, we will merge the loopback devices and the real Windows partition into a single linear RAID disk image (We will assume that the windows partition is <tt class="docutils literal">/dev/sda2</tt>):</p> <pre class="code shell literal-block">
sudo mdadm --build --verbose /dev/md0 --chunk<span class="o">=</span><span class="m">512</span> --level<span class="o">=</span>linear --raid-devices<span class="o">=</span><span class="m">3</span> /dev/loop0 /dev/sda2 /dev/loop1
</pre> <p>Time to create the partitions table of the new RAID disk reusing the same physical Windows partition. For this step, we will use <em>parted</em> utility. You can use other tool of your choose.</p> <p>Partition your virtual RAID disk:</p> <pre class="code shell literal-block">
sudo parted /dev/md0
<span class="o">(</span>parted<span class="o">)</span> unit s
<span class="o">(</span>parted<span class="o">)</span> mktable gpt
<span class="o">(</span>parted<span class="o">)</span> mkpart primary fat32 <span class="m">2048</span> <span class="m">204799</span>    <span class="c1"># depends on size of efi1 file
</span><span class="o">(</span>parted<span class="o">)</span> mkpart primary ntfs <span class="m">204800</span> -2049    <span class="c1"># depends on size of efi1 and efi2 files
</span><span class="o">(</span>parted<span class="o">)</span> <span class="nb">set</span> <span class="m">1</span> boot on
<span class="o">(</span>parted<span class="o">)</span> <span class="nb">set</span> <span class="m">1</span> esp on
<span class="o">(</span>parted<span class="o">)</span> <span class="nb">set</span> <span class="m">2</span> msftdata on
<span class="o">(</span>parted<span class="o">)</span> name <span class="m">1</span> EFI
<span class="o">(</span>parted<span class="o">)</span> name <span class="m">2</span> Windows
<span class="o">(</span>parted<span class="o">)</span> quit
</pre> <p>Your final layout will have 2 partitions; Windows partition <tt class="docutils literal">/dev/md0p2</tt> and EFI partition <tt class="docutils literal">/dev/md0p1</tt>. The EFI partition need to be formatted.</p> <pre class="code shell literal-block">
sudo mkfs.msdos -F <span class="m">32</span> -n EFI /dev/md0p1
</pre> <p>Now let add Windows boot entry to the virtual RAID disk.</p> <p>Boot to Windows live DVD from inside Qemu virtual machine with <tt class="docutils literal">/dev/md0</tt> as disk after changing <tt class="docutils literal">/dev/md0</tt> owner to the current user and installing <em>Ovmf</em> EFI bios, which in my case, it is available at <tt class="docutils literal">/usr/share/ovmf/ovmf_x64.bin</tt>.</p> <pre class="code shell literal-block">
chown <span class="nv">$USER</span>:<span class="nv">$USER</span> /dev/md0  <span class="c1"># We need to change the owner of md0
</span>qemu-system-x86_64 <span class="se">\
</span>    -bios /usr/share/ovmf/ovmf_x64.bin <span class="se">\
</span>    -drive <span class="nv">file</span><span class="o">=</span>/dev/md0,media<span class="o">=</span>disk,format<span class="o">=</span>raw <span class="se">\
</span>    -cpu host -enable-kvm -m 2G <span class="se">\
</span>    -cdrom /path/to/windows.iso
</pre> <p>Press <tt class="docutils literal">Shift+F10</tt> when Windows installer starts to open the terminal. We need to assign letter to EFI volume (partition).</p> <pre class="code batch literal-block">
diskpart
DISKPART<span class="p">&gt;</span> list disk
DISKPART<span class="p">&gt;</span> select disk 0    # Select the disk
DISKPART<span class="p">&gt;</span> list volume      # Find EFI volume (partition) number
DISKPART<span class="p">&gt;</span> select volume 2  # Select EFI volume
DISKPART<span class="p">&gt;</span> assign letter=B  # Assign B: to EFI volume
DISKPART<span class="p">&gt;</span> exit
</pre> <p>Finally, we create BCD boot entry for Windows partition on the same terminal.</p> <pre class="code batch literal-block">
bcdboot C:\Windows /s B: /f ALL
</pre> <p>Now, you are ready to boot to Windows from inside Qemu.</p> <pre class="code shell literal-block">
qemu-system-x86_64 <span class="se">\
</span>    -bios /usr/share/ovmf/ovmf_x64.bin <span class="se">\
</span>    -drive <span class="nv">file</span><span class="o">=</span>/dev/md0,media<span class="o">=</span>disk,format<span class="o">=</span>raw <span class="se">\
</span>    -cpu host -enable-kvm -m 2G
</pre> <p>After each Linux system reboot, you need to create the loopback devices, merge the partitions into the RAID disk and change the owner of the device before launching the virtual machine. You can find <a class="reference external" href="https://github.com/lejenome/dotfiles/blob/master/bin/ws">the script I use</a> as reference.</p> <p>Credit to <a class="reference external" href="https://wiki.archlinux.org/index.php/QEMU#Simulate_virtual_disk_with_MBR_using_linear_RAID">Arch Linux Wiki</a>. Enjoy!</p> </div> </article> </section> <nav id="posts-nav"> <ul><li><a href="post/github-push-webhook-implementation" rel="next" id="prev-post">Newer</a></li> <li><a href="post/slack-feedback-form" rel="prev" id="next-post">Older</a></li> </ul> </nav> </div> <script>function linenumber(n){var l;for(l=0;l<n.length;l++){var e=n[l].innerHTML;e='<ol class="linenums"><li><span class="codeline">'+e.split("\n").slice(0,-1).join('</span></li><li><span class="codeline">')+"</span></li></ol>",n[l].innerHTML=e}}linenumber(document.querySelectorAll(".code pre"))</script> <noscript id="deferred-styles"> <link rel="stylesheet" type="text/css" href="css/font-awesome.css"> <link rel="stylesheet" type="text/css" href="css/source-code-pro.css"> <link rel="stylesheet" type="text/css" href="css/pygmentize.default.css"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i,900,900i"> </noscript> <script>var loadDeferredStyles=function(){var e=document.getElementById("deferred-styles"),t=document.createElement("div");t.innerHTML=e.textContent,document.body.appendChild(t),e.parentElement.removeChild(e)},raf=requestAnimationFrame||mozRequestAnimationFrame||webkitRequestAnimationFrame||msRequestAnimationFrame;raf?raf(function(){window.setTimeout(loadDeferredStyles,0)}):window.addEventListener("load",loadDeferredStyles)</script> <script type="text/javascript">var _paq=_paq||[];_paq.push(["enableHeartBeatTimer"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){var e="https://api.admin.tik.tn/p";_paq.push(["setTrackerUrl",e]),_paq.push(["setSiteId",1]);var a=document,t=a.createElement("script"),p=a.getElementsByTagName("script")[0];t.type="text/javascript",t.async=!0,t.defer=!0,t.src=e,p.parentNode.insertBefore(t,p)}()</script> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-2482029926365022",enable_page_level_ads:!0})</script> </body> </html>